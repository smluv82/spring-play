## CoroutineBuilder & Job

- runBlocking과 launch 함수는 코루틴을 생성하는데 사용되는 함수라고 해서 코루틴 빌더 함수라고 부름.
- 코루틴이 만들어지고, Job 객체가 생성돼 반환 된다.
- 반환된 Job 객체는 코루틴의 상태를 추적하고 제어하는데 사용


1. Join을 이용한 코루틴 순차 처리
    1. Job 객체는 순차 처리가 필요한 상황을 위해 join 함수를 통해 코루틴이 실행 완료 될때까지 호출부의 코루틴을 일시 중단 하도록 만들 수 있다.
    2. Thread.sleep 함수를 쓰면 스레드가 블로킹 되어서 사용을 못하지만, delay 함수를 쓰면 양보를 해서 해당 스레드를 중단 된 동안 사용 할 수 있음.
    3. join 함수를 호출한 코루틴은 join의 대상이 된 코루틴이 완료 될 때까지 일시 중단. 이점 때문에 일시 중단이 가능한 지점(코루틴 등)에서만 호출 가능.
2. JoinAll을 이용한 코루틴 순차 처리
    1. 복수의 코루틴의 실행이 모두 끝날때까지 호출부의 코루틴을 일시 중단시키는 joinAll 함수를 제공
    2. joinAll 함수는 job 객체를 가변 인자(vararg, 자바로 치면 ...)로 각 job 객체에 대해 모두 join 함수를 호출하는 구조
3. CoroutineStart.LAZY 사용해 코루틴 지연 시작
    1. 지연 시작을 살펴보기 위한 준비
        1. launch 함수는 지연 없이 실행.
        2. 코루틴을 지연 시작하기 위해서는 launch 함수의 start인자로 CoroutineStart.LAZY를 넘겨 코루틴에 지연 시작 옵션 적용
        3. 해당 옵션을 넣은 코루틴을 지연 코루틴 (Lay Coroutine)으로 생성되며, 별도 실행 요청이 있을 떄까지 실행 되지 않는다.
        4. Job을 받아서 start 함수로 실행 시킨다.
       ```
       runBlocking {
            val lazyJob = launch(Dispatchers.IO, start = CoroutineStart.LAZY) {
                println("${Thread.currentThread().name} coroutine start")
            }
            println("${Thread.currentThread().name} coroutine main")
            delay(2000L)
            lazyJob.start()
        }
       ```

4. 코루틴 취소하기
    1. job의 cancel() 함수를 이용한 코루틴 작업을 취소할 수 있다.
    2. 코루틴이 취소된 후에 실행되어야 하는 함수, 즉 순차처리가 되어야 한다고 하면 cancelAndJoin() 함수를 이용한다.
    3. cancel()이나 cancelAndJoin() 함수를 사용했다고 해서 코루틴이 즉시 취소 되는것 아님. 코루틴이 취소를 확인할 수 있는 시점이 있어야지만 취소가 된다.
    4. 취소 확인 시점은 일시 중단 지점이나, 코루틴이 실행을 대기하는 시점이며, 이 시점들이 없다면 코루틴은 취소되지 않는다.
    5. 취소 시점은 3가지 방법으로 취소 할 수 있음. delay, yield, CoroutineScope.isActive를 사용한 취소 가능함.
5. 코루틴 취소하기 확인
    1. delay 함수는 일시 중단 함수로 선언돼 특정 시간만큼 호출부의 코루틴을 일시 중단하게 만듬.
    2. yield 함수는 양보라는 뜻으로 yield 함수가 호출되면 코루틴은 자신이 사용하던 스레드를 양보한다. (즉, 이때 취소 처리 여부 확인)
    3. CoroutineScope는 코루틴이 활성화 됐는지 확인 할 수 있는 Boolean 타입의 프로퍼티인 isActive를 제공
    4. 코루틴에 취소 요청이 되면 isActive의 값이 false로 바뀜.
6. 코루틴의 상태와 Job의 상태 변수
    1. 생성, 실행 중, 실행 완료, 취소 중, 취소 완료, (실행 완료 중)의 상태가 있다.
    2. Job 객체에서 외부로 공개하는 코루틴의 상태 변수는 isActive, isCancelled, isCompleted 3가지가 있으면, 모두 Boolean 변수이다.
    3. isActive : true이면 코루틴 활성 화 중인 상태,
    4. isCancelled : true이면 취소 요청된 상태. 취소가 완료된 상태라는 말은 아니다. (취소중이거나 취소완료 상태)
    5. isCompleted : true이면 코루틴 실행 완료 또는 취소 완료 상태
7. 코루틴 상태 정리

---

| 코루틴 상태           | isActive | isCancelled | isCompleted |
|------------------|----------|-------------|-------------|
| 생성(New)          | false    | false       | false       |
| 실행 중(Active)     | true     | false       | false       |
| 실행 완료(Completed) | false    | false       | true        |
| 취소 중(Cancelling) | false    | true        | false       |
| 취소 완료(Cancelled) | false    | true        | true        |

   
---

8. 요약
    1. runBlocking, launch 함수는 코루틴을 만들기 위한 코루틴 빌더 함수
    2. launch 함수를 호출하면 Job객체가 리턴되며, Job 객체는 코루틴의 상태를 추적하고 제어하는데 사용
    3. join 함수를 호출하면 호출한 코루틴이 실행이 완료될 때까지 일시 중단
    4. joinAll 함수를 사용해 복수의 코루틴이 실행 완료될 때까지 대기 할 수 있다.
    5. cancel 함수를 사용해 코루틴에 취소를 요청할 수 있으며, 코루틴이 곧바로 취소되는 것이 아니라 취소 플래그의 상태가 바뀌고, 취소가 확인될 때 비로소 취소된다.
    6. 취소가 완료될 때까지 대기하고 나서 다음 코드를 실행시키고 싶으면 cancel 대신 cancelAndJoin 함수를 사용
    7. cancel 함수를 호출하더라도 코루틴이 취소를 확인 할 수 없는 상태에서는 계속해서 실행된다.
    8. delay, yield, isActive 프로퍼티 등을 사용해 코루틴이 취소를 확인 할 수 있도록 만든다.
    9. 코루틴은 생성, 실행 중, 실행 완료 중, 실행 완료, 취소 중, 취소 완료 상태 (6가지) 를 가질 수 있다.
    10. Job 객체는 isActive, isCancelled, isCompleted 프로퍼티를 통해 코루틴의 상태를 나타낸다.
    11. 코루틴 라이브러리를 효율적으로 사용하기 위해서는 코루틴의 상태 변화를 이해하는 것이 중요하다.
   